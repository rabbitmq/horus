%% This Source Code Form is subject to the terms of the Mozilla Public
%% License, v. 2.0. If a copy of the MPL was not distributed with this
%% file, You can obtain one at https://mozilla.org/MPL/2.0/.
%%
%% Copyright Â© 2022-2025 Broadcom. All Rights Reserved. The term "Broadcom"
%% refers to Broadcom Inc. and/or its subsidiaries.
%%

-module(otp28_atom_table).

-include_lib("eunit/include/eunit.hrl").

%% This test demonstrates the atom table format incompatibility
%% between OTP 28 and older versions introduced in
%% https://github.com/erlang/otp/pull/8913

%% To regenerate OTP28_BEAM_BINARY, save the following code into otp28_atoms.erl:
%%
%% -module(otp28_atoms).
%% -export([test_fun/0]).
%%
%% test_fun() ->
%%     Fun = fun() ->
%%               {ok, foo, bar, baz}
%%           end,
%%     Fun().
%%
%% Then compile with OTP 28: erlc +debug_info otp28_atoms.erl
%% Print with Erlang shell: {ok, Beam} = file:read_file("otp28_atoms.beam"), io:format("~w~n", [Beam]).
-define(OTP28_BEAM_BINARY,
    <<70,79,82,49,0,0,3,132,66,69,65,77,65,116,85,56,0,0,0,60,255,255,255,
        251,176,111,116,112,50,56,95,97,116,111,109,115,128,116,101,115,116,95,
        102,117,110,176,109,111,100,117,108,101,95,105,110,102,111,96,101,114,108,
        97,110,103,240,103,101,116,95,109,111,100,117,108,101,95,105,110,102,111,
        67,111,100,101,0,0,0,71,0,0,0,16,0,0,0,0,0,0,0,177,0,0,0,7,0,0,0,
        3,1,16,153,16,2,18,34,0,1,32,64,71,0,3,19,1,48,153,0,2,18,50,0,1,
        64,64,18,3,78,16,0,1,80,153,0,2,18,50,16,1,96,64,3,19,64,18,3,78,32,
        16,3,0,83,116,114,84,0,0,0,0,73,109,112,84,0,0,0,28,0,0,0,2,0,0,0,
        4,0,0,0,5,0,0,0,1,0,0,0,4,0,0,0,5,0,0,0,2,69,120,112,84,0,0,0,
        40,0,0,0,3,0,0,0,3,0,0,0,1,0,0,0,6,0,0,0,3,0,0,0,0,0,0,0,4,0,
        0,0,2,0,0,0,0,0,0,0,2,76,105,116,84,0,0,0,34,0,0,0,0,0,0,0,1,0,
        0,0,22,131,104,4,119,2,111,107,119,3,102,111,111,119,3,98,97,114,119,3,
        98,97,122,0,0,77,101,116,97,0,0,0,45,131,108,0,0,0,1,104,2,119,16,
        101,110,97,98,108,101,100,95,102,101,97,116,117,114,101,115,108,0,0,0,1,
        119,10,109,97,121,98,101,95,101,120,112,114,106,106,0,0,0,76,111,99,84,
        0,0,0,4,0,0,0,0,65,116,116,114,0,0,0,39,131,108,0,0,0,1,104,2,119,
        3,118,115,110,108,0,0,0,1,110,16,0,79,115,182,7,12,38,246,75,176,118,
        77,150,243,234,84,249,106,106,0,67,73,110,102,0,0,0,116,131,108,0,0,0,
        3,104,2,119,7,118,101,114,115,105,111,110,107,0,5,57,46,48,46,50,104,2,
        119,7,111,112,116,105,111,110,115,108,0,0,0,1,119,10,100,101,98,117,103,
        95,105,110,102,111,106,104,2,119,6,115,111,117,114,99,101,107,0,48,47,
        85,115,101,114,115,47,109,107,117,114,97,116,99,122,121,107,47,114,97,98,
        98,105,116,109,113,47,104,111,114,117,115,47,111,116,112,50,56,95,97,116,
        111,109,115,46,101,114,108,106,68,98,103,105,0,0,1,53,131,80,0,0,2,15,
        120,156,101,145,77,78,195,48,16,133,19,39,46,41,21,20,36,54,108,16,39,
        32,130,21,39,224,6,172,163,73,226,224,56,78,92,252,211,129,158,158,113,
        131,68,74,119,227,207,111,222,188,177,101,134,87,173,168,195,71,213,79,
        157,169,246,207,120,43,172,174,160,118,222,66,227,171,198,180,66,50,157,
        36,9,151,57,174,193,123,219,215,193,19,131,20,82,204,187,94,83,61,36,91,
        227,119,47,175,21,120,51,186,39,114,128,244,92,206,112,53,154,54,104,129,
        155,133,250,191,142,69,157,248,218,25,235,227,216,84,50,44,188,112,190,
        234,194,4,137,146,28,11,170,26,223,155,137,212,57,133,88,92,207,29,28,
        87,141,134,224,196,44,80,42,98,70,131,248,8,190,145,68,57,112,153,97,
        182,7,59,31,48,123,11,83,36,228,114,36,27,26,123,49,155,184,115,83,14,
        215,179,105,74,61,220,135,93,124,4,88,193,54,178,156,88,30,87,59,162,27,
        100,102,56,33,119,52,197,152,19,116,143,89,77,81,150,232,33,162,131,82,
        138,98,231,13,104,77,180,88,166,46,126,83,71,9,195,76,152,142,224,154,
        182,157,151,37,212,96,59,36,143,229,187,19,214,149,227,16,44,45,127,248,
        30,74,11,117,221,251,241,179,148,198,6,135,151,127,255,175,126,0,193,154,
        158,247,0,0,0,76,105,110,101,0,0,0,21,0,0,0,0,0,0,0,0,0,0,0,3,0,0,
        0,1,0,0,0,0,65,0,0,0,84,121,112,101,0,0,0,10,0,0,0,3,0,0,0,1,15,
        255,0,0>>
).

otp28_atom_table_format_incompatibility_test() ->
    Beam = ?OTP28_BEAM_BINARY,

    %% Try to load the module - this will fail on OTP versions older than 28
    case code:load_binary(otp28_atoms, "otp28_atoms.beam", Beam) of
        {module, otp28_atoms} ->
            ok = horus:override_object_code(otp28_atoms, Beam),

            Fun = fun otp28_atoms:test_fun/0,

            StandaloneFun = horus:to_standalone_fun(Fun),
            Result = horus:exec(StandaloneFun, []),

            horus:forget_overridden_object_code(otp28_atoms),

            ?assertEqual(
               {ok, foo, bar, baz},
               Result
              );
        {error, badfile} ->
            error(todo)
    end.
